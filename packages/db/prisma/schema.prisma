generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum PrepVoteValue {
  AGREE
  DISAGREE
}

enum PromptFeedbackDimension {
  CORRECT
  INCORRECT
  FUN
  BORING
  USEFUL
  NOT_USEFUL
  SURPRISING
  CONFUSING
  COMMON
  SPARSE
}

enum ReadingState {
  READING
  DONE
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  MEMBER
  CURATOR
  ADMIN
}

model Author {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  bio       String?
  books     Book[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Genre {
  id          String      @id @default(cuid())
  name        String
  slug        String       @unique
  description String?
  books       BookGenre[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Book {
  id             String           @id @default(cuid())
  title          String
  slug           String           @unique
  subtitle       String?
  synopsis       String?          @db.VarChar(10000)
  publishedYear  Int?
  coverImageUrl  String?
  isbn           String?          @unique
  authorId       String
  author         Author           @relation(fields: [authorId], references: [id])
  genres         BookGenre[]
  preps          BookPrep[]
  prepSuggestions PrepSuggestion[]
  metadataSuggestions BookMetadataSuggestion[]
  readingStatuses ReadingStatus[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
}

model BookGenre {
  bookId  String
  genreId String
  book    Book   @relation(fields: [bookId], references: [id])
  genre   Genre  @relation(fields: [genreId], references: [id])
  addedAt DateTime @default(now())

  @@id([bookId, genreId])
}

model PrepKeyword {
  id          String            @id @default(cuid())
  name        String
  slug        String             @unique
  description String?
  preps       PrepKeywordOnPrep[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
}

model PrepKeywordOnPrep {
  prepId    String
  keywordId String
  prep      BookPrep   @relation(fields: [prepId], references: [id])
  keyword   PrepKeyword @relation(fields: [keywordId], references: [id])

  @@id([prepId, keywordId])
}

model BookPrep {
  id           String            @id @default(cuid())
  bookId       String
  heading      String
  summary      String            @db.VarChar(2000)
  watchFor     String?           @db.VarChar(2000)
  colorHint    String?
  createdById  String?
  book         Book              @relation(fields: [bookId], references: [id])
  createdBy    UserProfile?      @relation("UserProfileToBookPrep", fields: [createdById], references: [id])
  keywords     PrepKeywordOnPrep[]
  votes        PrepVote[]
  feedback     PromptFeedback[]
  score        PromptScore?
  quotes       PrepQuote[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model PrepQuote {
  id              String       @id @default(cuid())
  prepId          String
  userId          String
  text            String       @db.VarChar(2000)
  pageNumber      String?      @db.VarChar(20)
  chapter         String?      @db.VarChar(100)
  verified        Boolean      @default(false)
  verifiedSource  String?      @db.VarChar(500)
  prep            BookPrep     @relation(fields: [prepId], references: [id], onDelete: Cascade)
  user            UserProfile  @relation(fields: [userId], references: [id])
  votes           QuoteVote[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([prepId])
}

model QuoteVote {
  id        String        @id @default(cuid())
  quoteId   String
  userId    String
  value     PrepVoteValue
  quote     PrepQuote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  user      UserProfile   @relation(fields: [userId], references: [id])
  createdAt DateTime      @default(now())

  @@unique([quoteId, userId])
  @@index([quoteId])
}

model PrepVote {
  id        String       @id @default(cuid())
  prepId    String
  userId    String
  value     PrepVoteValue
  prep      BookPrep     @relation(fields: [prepId], references: [id])
  user      UserProfile  @relation(fields: [userId], references: [id])
  createdAt DateTime     @default(now())

  @@unique([prepId, userId])
}

model PromptFeedback {
  id         String                   @id @default(cuid())
  prepId     String
  userId     String
  dimension  PromptFeedbackDimension
  value      PrepVoteValue
  note       String?                  @db.VarChar(500)
  prep       BookPrep                 @relation(fields: [prepId], references: [id])
  user       UserProfile              @relation(fields: [userId], references: [id])
  createdAt  DateTime                 @default(now())
  updatedAt  DateTime                 @updatedAt

  @@unique([prepId, userId, dimension])
}

model PromptScore {
  prepId           String   @id
  agreeCount       Int      @default(0)
  disagreeCount    Int      @default(0)
  totalCount       Int      @default(0)
  score            Float    @default(0)
  dimensionTallies Json?
  lastFeedbackAt   DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  prep             BookPrep @relation(fields: [prepId], references: [id])
}

model PrepSuggestion {
  id             String           @id @default(cuid())
  bookId         String
  submittedById  String
  title          String
  description    String
  keywordHints   Json?
  status         SuggestionStatus @default(PENDING)
  moderatorNote  String?
  book           Book             @relation(fields: [bookId], references: [id])
  submittedBy    UserProfile      @relation(fields: [submittedById], references: [id])
  createdAt      DateTime         @default(now())
  reviewedAt     DateTime?
}

model BookSuggestion {
  id             String           @id @default(cuid())
  title          String
  authorName     String
  notes          String?
  genreIdeas     Json?
  prepIdeas      Json?
  status         SuggestionStatus @default(PENDING)
  submittedById  String?
  submittedBy    UserProfile?     @relation(fields: [submittedById], references: [id])
  createdAt      DateTime         @default(now())
  reviewedAt     DateTime?
}

model BookMetadataSuggestion {
  id                String           @id @default(cuid())
  bookId            String
  submittedById     String?
  suggestedSynopsis String?          @db.Text
  suggestedGenres   Json?
  status            SuggestionStatus @default(PENDING)
  moderatorNote     String?
  createdAt         DateTime         @default(now())
  reviewedAt        DateTime?
  book              Book             @relation(fields: [bookId], references: [id])
  submittedBy       UserProfile?     @relation(fields: [submittedById], references: [id])
}

model UserProfile {
  id              String          @id @default(cuid())
  cognitoSub      String          @unique
  email           String          @unique
  displayName     String
  avatarUrl       String?
  preferences     Json?
  role            UserRole        @default(MEMBER)
  prepVotes       PrepVote[]
  promptFeedback  PromptFeedback[]
  prepSuggestions PrepSuggestion[]
  bookSuggestions BookSuggestion[]
  metadataSuggestions BookMetadataSuggestion[]
  createdPreps    BookPrep[]      @relation("UserProfileToBookPrep")
  readingStatuses ReadingStatus[]
  prepQuotes      PrepQuote[]
  quoteVotes      QuoteVote[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model ReadingStatus {
  id        String       @id @default(cuid())
  userId    String
  bookId    String
  status    ReadingState @default(READING)
  user      UserProfile  @relation(fields: [userId], references: [id])
  book      Book         @relation(fields: [bookId], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([userId, bookId])
}

